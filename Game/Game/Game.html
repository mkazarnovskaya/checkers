<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Checkers</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./Content/bootstrap.min.css">
	<link rel="stylesheet" href="./Content/game.css">
	<script src="Scripts/jquery-3.0.0.min.js"></script>
	<script src="Scripts/umd/popper.min.js"></script>
	<script src="Scripts/bootstrap.min.js"></script>
	<script src="Scripts/checkers/primitives.js"></script>
	<script src="Scripts/checkers/position.js"></script>
	<script src="Scripts/checkers/move.js"></script>
	<script type="text/javascript">
		$(document).ready(function () {
			$(".black-cell").click(function () {
				var cellIndex = getCellIndexByCellId(this.id);
				if ($(this).hasClass("contains-movable-piece")) {
					$(".selected-for-move").removeClass("selected-for-move");
					$(".possible-move-target").removeClass("possible-move-target");
					$(this).addClass("selected-for-move");
					var cellIndex = getCellIndexByCellId(this.id);
					var possibleMoves = _currentPosition.findMovesFromCell(cellIndex);
					possibleMoves.forEach(function (move) {
						let targetCellIndex = move.getLastTargetCell();
						let targetCell = getCellByCellIndex(targetCellIndex);
						targetCell.addClass("possible-move-target");
					});
				}
				else if ($(this).hasClass("possible-move-target")) {
					var startCell = getCellIndexByCellId($(".selected-for-move").attr("id"));
					var selectedMove = _currentPosition.findMovesFromCell(startCell).filter(m => {
						var targetCell = m.getLastTargetCell();
						return (targetCell.row == cellIndex.row && targetCell.col == cellIndex.col);
					})[0];
					_currentPosition = selectedMove.end;
					updateDesk();
				}
			});

			$.ajax({
				url: "./TrainedModels/model_12.json",
				success: function (data) {
					startGame(false);
				}
			});
		});

		var _currentPosition;
		var _blackPlayer;
		function startGame(blackPlayer) {
			_currentPosition = new Checkers.Position();
			_currentPosition.initialize();
			_blackPlayer = blackPlayer;
			//if (blackPlayer) -> make move
			updateDesk();
		}

		function updateDesk() {
			let classesToRemove = ["contains-black-simple", "contains-black-king", "contains-white-simple", "contains-white-king", "contains-movable-piece"];
			for (let row = 0; row < 8; ++row) {
				for (let col = 0; col < 4; ++col) {
					let cellId = "cell_" + row + "_" + col;
					var cell = $("#" + cellId);
					classesToRemove.forEach(function (className) {
						cell.removeClass(className);
					});
					let cellIndex = new Checkers.CellIndex(row, col);
					let cellValue = _currentPosition.getCellValue(cellIndex);

					if (cellValue == Checkers.WHITE_SIMPLE)
						cell.addClass("contains-white-simple");
					else if (cellValue == Checkers.WHITE_KING)
						cell.addClass("contains-white-king");
					else if (cellValue == Checkers.BLACK_SIMPLE)
						cell.addClass("contains-black-simple");
					else if (cellValue == Checkers.BLACK_KING)
						cell.addClass("contains-black-king");

					if (isMyPiece(cellIndex) && _currentPosition.findMovesFromCell(cellIndex).length > 0) {
						cell.addClass("contains-movable-piece");
					}
				}
			}
		}

		function isMyPiece(cellIndex) {
			let cellValue = _currentPosition.getCellValue(cellIndex);
			if (cellValue == Checkers.CellValue.Empty)
				return false;
			return ((_blackPlayer && (cellValue & Checkers.CellValue.Black)) || (!_blackPlayer && !(cellValue & Checkers.CellValue.Black)));
		}

		function getCellIndexByCellId(cellId) {
			let idParts = cellId.split("_");
			return cellIndex = new Checkers.CellIndex(Number(idParts[1]), Number(idParts[2]));
		}

		function getCellByCellIndex(cellIndex) {
			let cellId = "cell_" + cellIndex.row + "_" + cellIndex.col;
			return $("#" + cellId);
		}

	</script>
</head>
<body class="bg-secondary">
	<nav class="navbar navbar-expand bg-dark navbar-dark small">
		<ul class="navbar-nav">
			<li class="nav-item active">
				<a class="nav-link" href="#">New Game - White</a>
			</li>
			<li class="nav-item active">
				<a class="nav-link" href="#">New Game - Black</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="#">Rules</a>
			</li>
		</ul>
	</nav>
	<br>
	<div class="container body-content">
		<div class="row">
			<div class="col-md-3 col-1"></div>
			<div class="col-md-6 col-10">
				<div class="container">
					<div class="row">
						<div class="col bg-light"></div>
						<div id="cell_7_0" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_7_1" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_7_2" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_7_3" class="col black-cell"></div>
					</div>
					<div class="row">
						<div id="cell_6_0" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_6_1" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_6_2" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_6_3" class="col black-cell"></div>
						<div class="col bg-light"></div>
					</div>
					<div class="row">
						<div class="col bg-light"></div>
						<div id="cell_5_0" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_5_1" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_5_2" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_5_3" class="col black-cell"></div>
					</div>
					<div class="row">
						<div id="cell_4_0" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_4_1" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_4_2" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_4_3" class="col black-cell"></div>
						<div class="col bg-light"></div>
					</div>
					<div class="row">
						<div class="col bg-light"></div>
						<div id="cell_3_0" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_3_1" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_3_2" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_3_3" class="col black-cell"></div>
					</div>
					<div class="row">
						<div id="cell_2_0" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_2_1" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_2_2" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_2_3" class="col black-cell"></div>
						<div class="col bg-light"></div>
					</div>
					<div class="row">
						<div class="col bg-light"></div>
						<div id="cell_1_0" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_1_1" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_1_2" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_1_3" class="col black-cell"></div>
					</div>
					<div class="row">
						<div id="cell_0_0" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_0_1" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_0_2" class="col black-cell"></div>
						<div class="col bg-light"></div>
						<div id="cell_0_3" class="col black-cell"></div>
						<div class="col bg-light"></div>
					</div>
				</div>
			</div>
			<div class="col-md-3 col-1"></div>
		</div>
	</div>

</body>
</html>